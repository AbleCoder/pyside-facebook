# This file is part of PySide-Facebook.
# Copyright (c) 2012 Brandon Orther. All rights reserved.
#
# The full license is available in the LICENSE file that was distributed with
# this source code.
#
# Author: Brandon Orther <an.able.coder@gmail.com>


"""
A general purpose PySide library to interact with facebook's API.
"""

from PySide.QtCore   import QUrl
from PySide.QtCore   import Signal
from PySide.QtWebKit import QWebView

# -----------------------------------------------------------------------------
# CONSTANTS
# -----------------------------------------------------------------------------

DEFAULT_REDIRECT_URI = "http://www.facebook.com/connect/login_success.html"
OAUTH_URL = "https://graph.facebook.com/oauth/authorize"


# -----------------------------------------------------------------------------
# EXCEPTIONS
# -----------------------------------------------------------------------------

class PySideFacebookException(Exception):

    pass


# -----------------------------------------------------------------------------

class FBAuthDialogException(PySideFacebookException):

    pass


# -----------------------------------------------------------------------------

class FBGraphAPI(PySideFacebookException):

    pass


# -----------------------------------------------------------------------------
# CLASSES
# -----------------------------------------------------------------------------

class FBAuthDialog(QWebView):

    """
    A QWebView extended to load Facebook's OAuth Dialog allowing a user to
    login and grant permissions to your facebook app and finally return the
    user's token or OAuth code.
    """

    # -------------------------------------------------------------------------
    # SIGNALS
    # -------------------------------------------------------------------------

    """
    Emitted when a user authenticates, authorizes the requested permissions
    AND the `response_type` was set to: code

    @param (str) oauth_code - OAuth code generated by facebook.
    @param (str) state      - The state value originally set in request.
    """
    signal_permsGrantedQAuthCode = Signal(str, str)

    # -------------------------------------------------------------------------

    """
    Emitted when a user authenticates, authorizes the requested permissions
    AND the `response_type` was set to: token

    @param (str) access_token - Authenticated user's facebook access token.
    @param (int) expires in   - Number of seconds until token expires.
    @param (str) state        - The state value originally set in request.
    """
    signal_permsGrantedAccessToken = Signal(str, int, str)

    # -------------------------------------------------------------------------

    """
    Emitted when a the requested permissions are NOT authorized by the user.

    @param (str) error       - Error code (example: access_denied)
    @param (str) reason      - Reason code (example: user_denied)
    @param (str) description - A string explaining the error.
    @param (str) state       - The state value originally set in request.
    """
    signal_permsDeclined = Signal(str, str, str, str)

    # -------------------------------------------------------------------------

    """
    Emitted when a user doesn't authenticate within the amount of time
    specified in `user_auth_timeout`.

    @param (int) time_elapsed - Number of seconds elapsed to cause the
                                timeout.
    """
    signal_userAuthTimeout = Signal(int)

    # -------------------------------------------------------------------------
    # METHODS
    # -------------------------------------------------------------------------

    def __init__(self, parent=None, app_id=None):
        """
        Instantiate FBAuthDialog object.

        @param (QWidget) [parent] Parent object that this widget belongs to.
        @param (str)     [app_id] Facebook App ID
        """

        super(FBAuthDialog, self).__init__(parent)

        self.set_oauth_params(app_id=app_id)

    # -------------------------------------------------------------------------

    def oauth_url(self, app_id, redirect_uri, scope, state, response_type,
            display):
        """
        Return encoded OAuth URL with request params formated as GET params.

        @param (str)  app_id
        @param (str)  redirect_uri
        @param (list) scope
        @param (str)  state
        @param (str)  response_type
        @param (str)  display
        """

        url = QUrl(OAUTH_URL)

        url.addQueryItem("client_id", app_id)
        url.addQueryItem("redirect_uri", redirect_uri)
        url.addQueryItem("response_type", response_type)
        url.addQueryItem("display", display)

        if scope:
            _scope = ",".join(map(unicode, scope))

            url.addQueryItem("scope", _scope)

        if state:
            url.addQueryItem("state", state)

        return url.toEncoded()

    # -------------------------------------------------------------------------

    def set_oauth_params(self, app_id=None, redirect_uri=DEFAULT_REDIRECT_URI,
            scope=[], state=None, response_type="token", display="page"):
        """
        Set QAuth request params values.

        Facebook OAuth Dialog Param References:
         - https://developers.facebook.com/docs/reference/dialogs/oauth/

        Facebook Permissions Reference
         - https://developers.facebook.com/docs/authentication/permissions/

        @param (str)  [app_id]
        @param (str)  [redirect_uri]
        @param (list) [scope]         A list of permissions
        @param (str)  [state]
        @param (str)  [response_type]
        @param (str)  [display]
        """

        self.oauth_params = {
            "app_id": app_id,
            "redirect_uri": DEFAULT_REDIRECT_URI,
            "scope": scope,
            "state": state,
            "response_type": response_type,
            "display": display,
        }

    # -------------------------------------------------------------------------

    def startAuth(self):
        """
        Start authentication process by opening OAuth Dialog view.
        """
        print "START THE AU6TH!!!"
